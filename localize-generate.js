// Generates src/locdata.js and loc_dot_views/*.dot
// Run using "npm run localize" (configured in package.json)

const fs = require('fs');

// Parse gettext translation files
// TODO: Parse .mo instead of .po? .mo.parse() was just returning false for me.
console.log('parsing gettext translation files');

var gettextParser = require('gettext-parser');
var f = fs.readFileSync('./translations/en_EN.po');
var en = gettextParser.po.parse(f);
var f = fs.readFileSync('./translations/jp_JP.po');
var jp = gettextParser.po.parse(f);
var translations = {en:en.translations[''], jp:jp.translations['']};

// Generate src/locdata.js, which is used by React components to localize
// their text.
console.log('starting React loc');

var tstr = JSON.stringify(translations);
var locdata = 
`// This file is auto-generated by "npm run localize".
module.exports = {
  data:${tstr}
};`;
fs.writeFileSync('./src/locdata.js', locdata);

// Generate translated versions of all DoT templates in dot_views.
console.log('starting DoT loc');

if (!fs.existsSync('./loc_dot_views')) {
  fs.mkdirSync('./loc_dot_views');
}

fs.readdirSync('./dot_views').forEach(file => {
  var parts = file.split('.');
  if (parts.length < 1 || parts[1] != 'dot') {
    return;
  }
  var templname = parts[0];
  var buf = fs.readFileSync('./dot_views/'+file);
  var original = buf.toString('ascii');

  var en = original;
  for (var key in translations.en) {
    if (key) {
      var value = translations.en[key].msgstr[0];
      if (!value) {
        console.log('Warning: empty translation for key '+key+' in locale en');
        value = key;
      }
      en = en.replace(`_("${key}")`, value);
    }
  }
  fs.writeFileSync(`./loc_dot_views/${templname}_en.dot`, en);

  var jp = original;
  for (var key in translations.jp) {
    if (key) {
      var value = translations.jp[key].msgstr[0];
      if (!value) {
        console.log('Warning: empty translation for key '+key+' in locale jp');
        value = key;
      }
      jp = jp.replace(`_("${key}")`, value);
    }
  }
  fs.writeFileSync(`./loc_dot_views/${templname}_jp.dot`, jp);
})

console.log('done');
